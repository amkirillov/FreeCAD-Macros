<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–∫—Ä–æ–π 1D: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #eceff1; color: #333; font-size: 13px; }
        .container { max-width: 1150px; margin: 0 auto; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #eee; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;}
        
        /* –°–µ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-grid { display: grid; grid-template-columns: 1.5fr 100px 80px 80px 90px 1.5fr; gap: 10px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 9px; font-weight: bold; margin-bottom: 3px; color: #777; text-transform: uppercase; }
        input, select { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; }

        .items-row { display: grid; grid-template-columns: 2fr 1fr 80px 35px; gap: 5px; margin-bottom: 5px; }
        .stock-row { display: grid; grid-template-columns: 1fr 80px 70px 35px; gap: 5px; margin-bottom: 5px; align-items: center; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 36px; display: flex; align-items: center; justify-content: center; }
        .btn-calc { background: #28a745; color: white; flex: 2; font-size: 15px; }
        .btn-add { background: #007bff; color: white; font-size: 10px; height: 24px; padding: 0 10px; }
        .btn-del { background: #ef5350; color: white; height: 32px; width: 32px; padding: 0; }
        
        .actions { display: flex; gap: 10px; margin-top: 15px; align-items: flex-end; }
        .actions .input-group { flex: 1; min-width: 150px; }

        /* –¢–∞–±–ª–∏—Ü—ã */
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; }
        .summary-table th, .summary-table td { border: 1px solid #cfd8dc; padding: 6px 10px; text-align: left; }
        .summary-table th { background: #f8f9fa; font-size: 11px; color: #666; }

        /* –•–ª—ã—Å—Ç—ã */
        .bin-container { margin-bottom: 15px; border: 1px solid #cfd8dc; padding: 10px; border-radius: 6px; background: #fff; page-break-inside: avoid; }
        .bin-info { font-size: 12px; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .bin-bar { height: 32px; background: #eee; display: flex; border-radius: 4px; overflow: hidden; border: 1px solid #ccc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        
        .part { height: 100%; border-right: 1px solid rgba(255,255,255,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; overflow: hidden; -webkit-print-color-adjust: exact; print-color-adjust: exact; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .part span { font-size: 8px; opacity: 0.9; font-weight: normal; margin-top: -1px; white-space: nowrap; }

        .trim { height: 100%; background: #ff0000 !important; -webkit-print-color-adjust: exact; flex-shrink: 0; }
        .kerf { height: 100%; background: #333 !important; flex-shrink: 0; }
        .waste { height: 100%; background: repeating-linear-gradient(45deg, #fdfdfd, #fdfdfd 5px, #eeeeee 5px, #eeeeee 10px) !important; color: #999; font-size: 9px; display: flex; align-items: center; padding-left: 5px; flex-grow: 1; -webkit-print-color-adjust: exact; }
        
        .summary { background: #e8f5e9; border-left: 5px solid #43a047; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none; }
        .badge-stock { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        @media print { .panel, .btn-add, .btn-del, .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <div class="settings-grid">
            <div class="input-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="projectName" oninput="save()"></div>
            <div class="input-group"><label>–ù–æ–≤—ã–π —Ö–ª—ã—Å—Ç (–º–º)</label><input type="number" id="stdStock" value="6000" oninput="save()"></div>
            <div class="input-group"><label>–¢–æ—Ä—Ü–æ–≤–∫–∞ (–º–º)</label><input type="number" id="trim" value="20" oninput="save()"></div>
            <div class="input-group"><label>–†–µ–∑ (–º–º)</label><input type="number" id="kerf" value="3" oninput="save()"></div>
            <div class="input-group"><label>–í–µ—Å 1–º (–∫–≥)</label><input type="number" id="weight" step="0.001" value="1.5" oninput="save()"></div>
            <div class="input-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label><input type="text" id="profileDesc" oninput="save()"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1.4fr; gap: 20px;">
            <div>
                <h2>–°–∫–ª–∞–¥ <button class="btn btn-add" onclick="addRow('stockContainer', false)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="stockContainer"></div>
            </div>
            <div>
                <h2>–ó–∞–≥–æ—Ç–æ–≤–∫–∏ <button class="btn btn-add" onclick="addRow('partsContainer', true)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="partsContainer"></div>
            </div>
        </div>
        
        <div class="actions">
            <div class="input-group">
                <label>–í–∏–¥ –æ—Ç—á–µ—Ç–∞</label>
                <select id="reportMode" onchange="save(); calculate()">
                    <option value="compact">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π</option>
                    <option value="detailed">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π (—Ç–∞–±–ª–∏—Ü—ã)</option>
                </select>
            </div>
            <button class="btn btn-calc" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <button class="btn" style="background:#673ab7; color:white" onclick="saveToFile()">üíæ JSON</button>
            <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)" accept=".json">
            <button class="btn" style="background:#ff9800; color:white" onclick="document.getElementById('fileInput').click()">üìÇ JSON</button>
            <button class="btn" style="background:#607d8b; color:white" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
            <button class="btn" style="background:#ccc" onclick="clearAll()">–°–±—Ä–æ—Å</button>
        </div>
    </div>

    <div id="summary" class="summary"></div>
    <div id="partsTableArea"></div>
    <div id="results"></div>
</div>

<script>
const KEY = 'cutData_Final';

function getColor(len) {
    const hue = (len * 137.5) % 360; 
    return `hsl(${hue}, 65%, 35%)`;
}

function addRow(containerId, isPart, val1='', val2='', val3='', val4=false) {
    const row = document.createElement('div');
    row.className = isPart ? 'items-row' : 'stock-row';
    row.innerHTML = isPart ? `
        <input type="text" placeholder="–ò–º—è" class="val-name" value="${val1}" oninput="save()">
        <input type="number" placeholder="–î–ª–∏–Ω–∞" class="val-len" value="${val2}" oninput="save()">
        <input type="number" placeholder="–ö–æ–ª-–≤–æ" class="val-qty" value="${val3}" oninput="save()">
        <button class="btn btn-del" onclick="this.parentElement.remove(); save();">‚úï</button>
    ` : `
        <input type="number" placeholder="–î–ª–∏–Ω–∞" class="val-len" value="${val1}" oninput="save()">
        <input type="number" placeholder="–ö–æ–ª-–≤–æ" class="val-qty" value="${val2}" oninput="save()">
        <label style="font-size:9px;"><input type="checkbox" class="val-trim-extra" ${val4 ? 'checked' : ''} onchange="save()"> –¢–æ—Ä—Ü.—Ö2</label>
        <button class="btn btn-del" onclick="this.parentElement.remove(); save();">‚úï</button>
    `;
    document.getElementById(containerId).appendChild(row);
}

function save() {
    const data = {
        projectName: document.getElementById('projectName').value,
        stdStock: document.getElementById('stdStock').value,
        trim: document.getElementById('trim').value,
        kerf: document.getElementById('kerf').value,
        weight: document.getElementById('weight').value,
        profileDesc: document.getElementById('profileDesc').value,
        reportMode: document.getElementById('reportMode').value,
        stock: Array.from(document.querySelectorAll('#stockContainer .stock-row')).map(r => ({
            len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value, extra: r.querySelector('.val-trim-extra').checked
        })),
        parts: Array.from(document.querySelectorAll('#partsContainer .items-row')).map(r => ({
            name: r.querySelector('.val-name').value, len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        }))
    };
    localStorage.setItem(KEY, JSON.stringify(data));
}

function load() {
    const data = JSON.parse(localStorage.getItem(KEY));
    if (!data) { addRow('stockContainer', false, 3000, 1); addRow('partsContainer', true, '–°—Ç–æ–π–∫–∞', 2100, 2); return; }
    document.getElementById('projectName').value = data.projectName || '';
    document.getElementById('stdStock').value = data.stdStock || 6000;
    document.getElementById('trim').value = data.trim || 20;
    document.getElementById('kerf').value = data.kerf || 3;
    document.getElementById('weight').value = data.weight || 1.5;
    document.getElementById('profileDesc').value = data.profileDesc || '';
    document.getElementById('reportMode').value = data.reportMode || 'compact';
    document.getElementById('stockContainer').innerHTML = '';
    document.getElementById('partsContainer').innerHTML = '';
    data.stock.forEach(s => addRow('stockContainer', false, s.len, s.qty, '', s.extra));
    data.parts.forEach(p => addRow('partsContainer', true, p.name, p.len, p.qty));
}

function calculate() {
    const kerf = parseFloat(document.getElementById('kerf').value) || 0;
    const trim = parseFloat(document.getElementById('trim').value) || 0;
    const stdStockLen = parseFloat(document.getElementById('stdStock').value);
    const weightPerM = parseFloat(document.getElementById('weight').value) || 0;
    const reportMode = document.getElementById('reportMode').value;
    
    let availableStock = [];
    document.querySelectorAll('#stockContainer .stock-row').forEach(row => {
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        const extra = row.querySelector('.val-trim-extra').checked;
        if (len > 0 && qty > 0) for(let i=0; i<qty; i++) availableStock.push({ max: len, current: [], isStock: true, forceDouble: extra });
    });
    availableStock.sort((a, b) => a.max - b.max);

    let partsGrouped = [];
    document.querySelectorAll('#partsContainer .items-row').forEach(row => {
        const name = row.querySelector('.val-name').value || "–î–µ—Ç–∞–ª—å";
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        if (len > 0 && qty > 0) partsGrouped.push({ name, len, qty });
    });

    let partsFlat = [];
    partsGrouped.forEach(p => { for(let i=0; i<p.qty; i++) partsFlat.push({ name: p.name, len: p.len }); });
    partsFlat.sort((a, b) => b.len - a.len);

    const usedBins = [];
    partsFlat.forEach(p => {
        let placed = false;
        for (let bin of usedBins) {
            let tMult = bin.isStock ? (bin.forceDouble ? 2 : 1) : 2;
            let used = bin.current.reduce((s, x) => s + x.len, 0) + (bin.current.length * kerf) + (tMult * trim);
            if (used + p.len <= bin.max) { bin.current.push(p); placed = true; break; }
        }
        if (!placed) {
            for (let i = 0; i < availableStock.length; i++) {
                let tMult = availableStock[i].forceDouble ? 2 : 1;
                if (p.len + (tMult * trim) <= availableStock[i].max) {
                    let bin = availableStock.splice(i, 1)[0]; 
                    bin.current.push(p); usedBins.push(bin); placed = true; break;
                }
            }
        }
        if (!placed) {
            if (p.len + (2 * trim) > stdStockLen) { alert("–î–µ—Ç–∞–ª—å " + p.len + " –Ω–µ –≤–ª–µ–∑–∞–µ—Ç!"); return; }
            usedBins.push({ max: stdStockLen, current: [p], isStock: false });
        }
    });

    render(usedBins, kerf, trim, stdStockLen, weightPerM, partsGrouped, reportMode);
}

function render(bins, kerf, trim, stdStockLen, weightPerM, partsGrouped, mode) {
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    results.innerHTML = ''; let newCount = 0; let totalPartsLen = 0; let totalWeightInput = 0; let totalKerfLen = 0;
    const now = new Date().toLocaleString('ru-RU');

    let tableHtml = `<table class="summary-table"><thead><tr><th>–ò–º—è</th><th>–î–ª–∏–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–í–µ—Å —à—Ç</th><th>–í—Å–µ–≥–æ</th></tr></thead><tbody>`;
    partsGrouped.forEach(p => {
        totalPartsLen += (p.len * p.qty);
        tableHtml += `<tr><td>${p.name}</td><td>${p.len}</td><td>${p.qty} —à—Ç</td><td>${(p.len * weightPerM / 1000).toFixed(2)}</td><td>${(p.len * p.qty * weightPerM / 1000).toFixed(2)}</td></tr>`;
    });
    document.getElementById('partsTableArea').innerHTML = `<div style="font-size:10px; color:#888">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${now}</div><h3>–°–≤–æ–¥–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å</h3>` + tableHtml + `</tbody></table>`;

    bins.forEach((bin, i) => {
        if (!bin.isStock) newCount++;
        const sumLen = bin.current.reduce((s, p) => s + p.len, 0);
        const kerfsInBin = bin.current.length > 1 ? (bin.current.length - 1) : 0;
        totalKerfLen += (kerfsInBin * kerf);
        totalWeightInput += (bin.max * weightPerM / 1000);
        
        let tMult = bin.isStock ? (bin.forceDouble ? 2 : 1) : 2;
        const waste = bin.max - (sumLen + kerfsInBin * kerf + (tMult * trim));

        let detailedTable = '';
        if (mode === 'detailed') {
            let binMap = {};
            bin.current.forEach(p => { let k = `${p.name}||${p.len}`; binMap[k] = (binMap[k] || 0) + 1; });
            detailedTable = `<table style="width:100%; margin-top:5px; font-size:11px; border-top:1px dashed #ccc;">`;
            for (let k in binMap) {
                let [n, l] = k.split('||');
                detailedTable += `<tr><td><b>${n}</b></td><td>${l} –º–º</td><td>${binMap[k]} —à—Ç</td><td>${(l * binMap[k] * weightPerM / 1000).toFixed(2)} –∫–≥</td></tr>`;
            }
            detailedTable += `</table>`;
        }

        const wrap = document.createElement('div');
        wrap.className = 'bin-container';
        wrap.innerHTML = `
            <div class="bin-info">
                <span>‚Ññ${i+1} (${bin.max} –º–º) ${bin.isStock ? '<span class="badge-stock">–°–ö–õ–ê–î</span>' : '<b>–ù–û–í–´–ô</b>'} | ${(bin.max * weightPerM / 1000).toFixed(2)} –∫–≥ <span style="color:#d32f2f; margin-left:10px;">(–¢–æ—Ä—Ü–æ–≤–∫–∞: ${tMult}x${trim})</span></span>
                <span>–û—Å—Ç–∞—Ç–æ–∫: <b>${waste.toFixed(0)} –º–º</b></span>
            </div>
            <div class="bin-bar" style="width: ${(bin.max / stdStockLen * 100)}%">
                ${(tMult === 2) ? `<div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>` : ''}
                ${bin.current.map((p, idx) => `
                    <div class="part" style="width: ${(p.len / bin.max * 100)}%; background: ${getColor(p.len)}">${p.len}<span>${p.name}</span></div>
                    ${idx < bin.current.length - 1 ? `<div class="kerf" style="width: ${(kerf / bin.max * 100)}%"></div>` : ''}
                `).join('')}
                <div class="waste">${waste > 15 ? Math.floor(waste) : ''}</div>
                <div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>
                
            </div>${detailedTable}`;
        results.appendChild(wrap);
    });

    const cleanW = (totalPartsLen * weightPerM / 1000).toFixed(2); // –í–µ—Å –≤—Å–µ—Ö –∑–∞–≥–æ—Ç–æ–≤–æ–∫
    const shavingsW = (totalKerfLen * weightPerM / 1000).toFixed(2); // –í–µ—Å –ø—ã–ª–∏ –æ—Ç –ø–∏–ª—ã
    const totalW = totalWeightInput.toFixed(2); // –û–±—â–∏–π –≤–µ—Å –∑–∞–∫—É–ø–∫–∏ + —Å–∫–ª–∞–¥–∞
    const scrapW = (totalWeightInput - cleanW - shavingsW).toFixed(2); // –í–µ—Å —Ç–≤–µ—Ä–¥—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤
    summary.style.display = 'block';
    summary.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h1 style="margin:0; font-size:1.3rem">${document.getElementById('projectName').value || '–ü—Ä–æ–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h1>
                <p style="margin:5px 0 0 0; color:#444;">–ü—Ä–æ—Ñ–∏–ª—å: <b>${document.getElementById('profileDesc').value || '‚Äî'}</b></p>
                <p style="margin:5px 0 0 0;">–ù–æ–≤—ã—Ö —Ö–ª—ã—Å—Ç–æ–≤: <b>${newCount} —à—Ç.</b> (${(newCount * stdStockLen / 1000).toFixed(2)} –º)</p>
            </div>
            <div style="text-align:right; font-size: 0.95rem; line-height: 1.6;">
                –û–±—â–∏–π –≤–µ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞: <b>${totalW} –∫–≥</b><br>
                –ß–∏—Å—Ç—ã–π –≤–µ—Å –¥–µ—Ç–∞–ª–µ–π: <b style="color:#2e7d32">${cleanW} –∫–≥</b><br>
                –°—Ç—Ä—É–∂–∫–∞: ${shavingsW} –∫–≥ | –û–±—Ä–µ–∑–∫–∏: ${scrapW} –∫–≥
            </div>
        </div>`;
}

function saveToFile() { save(); const blob = new Blob([localStorage.getItem(KEY)], {type:"application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = (document.getElementById('projectName').value || "project") + ".json"; a.click(); }
function loadFromFile(e) { const reader = new FileReader(); reader.onload = (ev) => { localStorage.setItem(KEY, ev.target.result); location.reload(); }; reader.readAsText(e.target.files[0]); }
function clearAll() { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) { localStorage.removeItem(KEY); location.reload(); } }
window.onload = load;
</script>
</body>
</html>
