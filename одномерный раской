<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–∫—Ä–æ–π 1D: –ü–æ–ª–Ω—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #eceff1; color: #333; font-size: 13px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #eee; font-size: 1rem; }
        
        .settings-grid { display: grid; grid-template-columns: 1.2fr 80px 70px 70px 90px 1.2fr; gap: 8px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 9px; font-weight: bold; margin-bottom: 3px; color: #777; text-transform: uppercase; }
        input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }

        .items-row, .stock-row { display: grid; gap: 5px; margin-bottom: 5px; align-items: center; }
        .items-row { grid-template-columns: 2fr 1fr 70px 35px; }
        .stock-row { grid-template-columns: 1fr 70px 35px; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #007bff; color: white; font-size: 10px; margin-left: 5px; }
        .btn-calc { background: #28a745; color: white; flex: 2; font-size: 15px; }
        .btn-print { background: #607d8b; color: white; flex: 1; }
        .btn-del { background: #ef5350; color: white; }

        /* –¢–∞–±–ª–∏—Ü–∞ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ */
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; border-radius: 5px; overflow: hidden; }
        .summary-table th, .summary-table td { border: 1px solid #cfd8dc; padding: 6px 10px; text-align: left; }
        .summary-table th { background: #f8f9fa; font-size: 11px; text-transform: uppercase; color: #666; }

        .bin-container { margin-bottom: 10px; border: 1px solid #cfd8dc; padding: 8px; border-radius: 5px; background: #fff; page-break-inside: avoid; }
        .bin-info { font-size: 11px; margin-bottom: 4px; display: flex; justify-content: space-between; color: #555; }
        .bin-bar { 
            height: 32px; background: #eee; display: flex; border-radius: 3px; overflow: hidden; border: 1px solid #ccc; 
            -webkit-print-color-adjust: exact; print-color-adjust: exact; 
        }
        
        .part { 
            height: 100%; border-right: 1px solid rgba(255,255,255,0.3); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: white; font-size: 9px; font-weight: bold; overflow: hidden;
            -webkit-print-color-adjust: exact; print-color-adjust: exact; 
        }
        .part span { font-size: 7px; opacity: 0.95; font-weight: normal; margin-top: -1px; white-space: nowrap; }

        .trim { height: 100%; background: #90a4ae !important; opacity: 0.4; -webkit-print-color-adjust: exact; }
        .kerf { height: 100%; background: #333 !important; -webkit-print-color-adjust: exact; }
        .waste { height: 100%; background: #fff; color: #999; font-size: 9px; display: flex; align-items: center; padding-left: 3px; flex-grow: 1; }
        
        .summary { background: #e8f5e9; border-left: 4px solid #43a047; padding: 15px; border-radius: 4px; margin-bottom: 15px; display: none; -webkit-print-color-adjust: exact; }
        .badge-stock { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; padding: 2px 5px; border-radius: 3px; font-size: 9px; font-weight: bold; }

        @media print {
            .panel, .btn-add, .btn-del { display: none !important; }
            body { background: white; padding: 0; }
            .container { max-width: 100%; }
            .bin-container { border: 1px solid #ddd; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <div class="settings-grid">
            <div class="input-group"><label>–ü—Ä–æ–µ–∫—Ç</label><input type="text" id="projectName" oninput="save()"></div>
            <div class="input-group"><label>–•–ª—ã—Å—Ç (–º–º)</label><input type="number" id="stdStock" value="6000" oninput="save()"></div>
            <div class="input-group"><label>–¢–æ—Ä—Ü. (–º–º)</label><input type="number" id="trim" value="20" oninput="save()"></div>
            <div class="input-group"><label>–†–µ–∑ (–º–º)</label><input type="number" id="kerf" value="3" oninput="save()"></div>
            <div class="input-group"><label>–í–µ—Å 1–º (–∫–≥)</label><input type="number" id="weight" step="0.001" value="1.5" oninput="save()"></div>
            <div class="input-group"><label>–ü—Ä–æ—Ñ–∏–ª—å</label><input type="text" id="profileDesc" oninput="save()"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
            <div>
                <h2>–°–∫–ª–∞–¥ <button class="btn btn-add" onclick="addRow('stockContainer', false)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="stockContainer"></div>
            </div>
            <div>
                <h2>–ó–∞–≥–æ—Ç–æ–≤–∫–∏ <button class="btn btn-add" onclick="addRow('partsContainer', true)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="partsContainer"></div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-calc" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <button class="btn" style="background:#673ab7; color:white" onclick="saveToFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
            
            <!-- –°–∫—Ä—ã—Ç–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–µ—ë -->
            <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)" accept=".json">
            <button class="btn" style="background:#ff9800; color:white" onclick="document.getElementById('fileInput').click()">üìÇ –û—Ç–∫—Ä—ã—Ç—å JSON</button>
            
            <button class="btn btn-print" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
            <button class="btn" style="background:#ccc" onclick="clearAll()">–°–±—Ä–æ—Å</button>
        </div>

    </div>

    <div id="summary" class="summary"></div>
    <div id="partsTableArea"></div>
    <div id="results"></div>
</div>

<script>
function getColor(len) {
    const hue = (len * 137.5) % 360; 
    return `hsl(${hue}, 65%, 35%)`;
}

function addRow(containerId, isPart, val1='', val2='', val3='') {
    const row = document.createElement('div');
    row.className = isPart ? 'items-row' : 'stock-row';
    row.innerHTML = `
        ${isPart ? `<input type="text" placeholder="–ò–º—è" class="val-name" value="${val1}" oninput="save()">` : ''}
        <input type="number" placeholder="–î–ª–∏–Ω–∞" class="val-len" value="${isPart ? val2 : val1}" oninput="save()">
        <input type="number" placeholder="–ö–æ–ª-–≤–æ" class="val-qty" value="${isPart ? val3 : val2}" oninput="save()">
        <button class="btn btn-del" onclick="this.parentElement.remove(); save();">‚úï</button>
    `;
    document.getElementById(containerId).appendChild(row);
}

function save() {
    const data = {
        projectName: document.getElementById('projectName').value,
        stdStock: document.getElementById('stdStock').value,
        trim: document.getElementById('trim').value,
        kerf: document.getElementById('kerf').value,
        weight: document.getElementById('weight').value,
        profileDesc: document.getElementById('profileDesc').value,
        stock: Array.from(document.querySelectorAll('#stockContainer .stock-row')).map(r => ({
            len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        })),
        parts: Array.from(document.querySelectorAll('#partsContainer .items-row')).map(r => ({
            name: r.querySelector('.val-name').value, len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        }))
    };
    localStorage.setItem('cutDataFull', JSON.stringify(data));
}

function load() {
    const data = JSON.parse(localStorage.getItem('cutDataFull'));
    if (!data) { addRow('stockContainer', false, 3000, 1); addRow('partsContainer', true, '–°—Ç–æ–π–∫–∞', 2100, 2); return; }
    document.getElementById('projectName').value = data.projectName || '';
    document.getElementById('stdStock').value = data.stdStock || 6000;
    document.getElementById('trim').value = data.trim || 20;
    document.getElementById('kerf').value = data.kerf || 3;
    document.getElementById('weight').value = data.weight || 1.5;
    document.getElementById('profileDesc').value = data.profileDesc || '';
    data.stock.forEach(s => addRow('stockContainer', false, s.len, s.qty));
    data.parts.forEach(p => addRow('partsContainer', true, p.name, p.len, p.qty));
}

function clearAll() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) { localStorage.removeItem('cutDataFull'); location.reload(); } }

function calculate() {
    const kerf = parseFloat(document.getElementById('kerf').value) || 0;
    const trim = parseFloat(document.getElementById('trim').value) || 0;
    const stdStockLen = parseFloat(document.getElementById('stdStock').value);
    const weightPerM = parseFloat(document.getElementById('weight').value) || 0;
    
    let availableStock = [];
    document.querySelectorAll('#stockContainer .stock-row').forEach(row => {
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        if (len > 0 && qty > 0) for(let i=0; i<qty; i++) availableStock.push({ max: len, current: [], isStock: true });
    });
    availableStock.sort((a, b) => a.max - b.max);

    let partsGrouped = [];
    document.querySelectorAll('#partsContainer .items-row').forEach(row => {
        const name = row.querySelector('.val-name').value || "–î–µ—Ç–∞–ª—å";
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        if (len > 0 && qty > 0) partsGrouped.push({ name, len, qty });
    });

    let partsFlat = [];
    partsGrouped.forEach(p => { for(let i=0; i<p.qty; i++) partsFlat.push({ name: p.name, len: p.len }); });
    partsFlat.sort((a, b) => b.len - a.len);

    const usedBins = [];
    partsFlat.forEach(p => {
        let placed = false;
        for (let bin of usedBins) {
            let used = bin.current.reduce((s, x) => s + x.len, 0) + (bin.current.length * kerf) + (trim * 2);
            if (used + p.len <= bin.max) { bin.current.push(p); placed = true; break; }
        }
        if (!placed) {
            for (let i = 0; i < availableStock.length; i++) {
                if (p.len + (trim * 2) <= availableStock[i].max) {
                    let bin = availableStock.splice(i, 1)[0]; bin.current.push(p); usedBins.push(bin); placed = true; break;
                }
            }
        }
        if (!placed) usedBins.push({ max: stdStockLen, current: [p], isStock: false });
    });

    render(usedBins, kerf, trim, stdStockLen, weightPerM, partsGrouped);
}

function render(bins, kerf, trim, stdStockLen, weightPerM, partsGrouped) {
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    const partsTableArea = document.getElementById('partsTableArea');
    
    results.innerHTML = ''; 
    let newCount = 0; let totalPartsLen = 0; let totalWeightInput = 0;

    // –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–≥–æ—Ç–æ–≤–æ–∫
    let tableHtml = `<table class="summary-table"><thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–î–ª–∏–Ω–∞ (–º–º)</th><th>–ö–æ–ª-–≤–æ</th><th>–í–µ—Å —à—Ç (–∫–≥)</th><th>–í—Å–µ–≥–æ (–∫–≥)</th></tr></thead><tbody>`;
    partsGrouped.forEach(p => {
        const wP = (p.len * weightPerM / 1000).toFixed(2);
        const wT = (p.len * p.qty * weightPerM / 1000).toFixed(2);
        tableHtml += `<tr><td>${p.name}</td><td>${p.len}</td><td>${p.qty} —à—Ç</td><td>${wP}</td><td>${wT}</td></tr>`;
    });
    tableHtml += `</tbody></table>`;
    partsTableArea.innerHTML = `<h3>–°–≤–æ–¥–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –∑–∞–≥–æ—Ç–æ–≤–æ–∫</h3>` + tableHtml;

    bins.forEach((bin, i) => {
        if (!bin.isStock) newCount++;
        const sumLen = bin.current.reduce((s, p) => s + p.len, 0);
        totalPartsLen += sumLen;
        totalWeightInput += (bin.max * weightPerM / 1000);
        const waste = bin.max - (sumLen + (bin.current.length - 1) * kerf + (trim * 2));

        const wrap = document.createElement('div');
        wrap.className = 'bin-container';
        wrap.innerHTML = `
            <div class="bin-info">
                <span>‚Ññ${i+1} (${bin.max} –º–º) ${bin.isStock ? '<span class="badge-stock">–°–ö–õ–ê–î</span>' : '<b>–ù–û–í–´–ô</b>'} | ${(bin.max * weightPerM / 1000).toFixed(2)} –∫–≥</span>
                <span>–û—Å—Ç–∞—Ç–æ–∫: <b>${waste.toFixed(0)} –º–º</b></span>
            </div>
            <div class="bin-bar" style="width: ${(bin.max / stdStockLen * 100)}%">
                <div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>
                ${bin.current.map((p, idx) => `
                    <div class="part" style="width: ${(p.len / bin.max * 100)}%; background: ${getColor(p.len)}" title="–í–µ—Å: ${(p.len * weightPerM / 1000).toFixed(2)} –∫–≥">
                        ${p.len}<span>${p.name}</span>
                    </div>
                    ${idx < bin.current.length - 1 ? `<div class="kerf" style="width: ${(kerf / bin.max * 100)}%"></div>` : ''}
                `).join('')}
                <div class="waste">${waste > 15 ? Math.floor(waste) : ''}</div>
                <div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>
            </div>`;
        results.appendChild(wrap);
    });

    summary.style.display = 'block';
    const cleanW = (totalPartsLen * weightPerM / 1000).toFixed(2);
    summary.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <b style="font-size:16px;">–ü—Ä–æ–µ–∫—Ç: ${document.getElementById('projectName').value}</b><br>
                –ü—Ä–æ—Ñ–∏–ª—å: ${document.getElementById('profileDesc').value}<br>
                –ó–∞–∫—É–ø–∫–∞: <b>${newCount} —à—Ç.</b> (${(newCount * stdStockLen / 1000).toFixed(2)} –º)
            </div>
            <div style="text-align:right">
                –û–±—â–∏–π –≤–µ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞: <b>${totalWeightInput.toFixed(2)} –∫–≥</b><br>
                –ß–∏—Å—Ç—ã–π –≤–µ—Å –¥–µ—Ç–∞–ª–µ–π: ${cleanW} –∫–≥ | –û—Ç—Ö–æ–¥: ${(totalWeightInput - cleanW).toFixed(2)} –∫–≥
            </div>
        </div>`;
}

// –ï–¥–∏–Ω—ã–π –∫–ª—é—á –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const STORAGE_KEY = 'cutDataV2026';

function save() {
    const data = {
        projectName: document.getElementById('projectName').value,
        stdStock: document.getElementById('stdStock').value,
        trim: document.getElementById('trim').value,
        kerf: document.getElementById('kerf').value,
        weight: document.getElementById('weight').value,
        profileDesc: document.getElementById('profileDesc').value,
        stock: Array.from(document.querySelectorAll('#stockContainer .stock-row')).map(r => ({
            len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        })),
        parts: Array.from(document.querySelectorAll('#partsContainer .items-row')).map(r => ({
            name: r.querySelector('.val-name').value, len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        }))
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function load() {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data) { 
        addRow('stockContainer', false, 3000, 1); 
        addRow('partsContainer', true, '–°—Ç–æ–π–∫–∞', 2100, 2); 
        return; 
    }
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
    document.getElementById('stockContainer').innerHTML = '';
    document.getElementById('partsContainer').innerHTML = '';

    document.getElementById('projectName').value = data.projectName || '';
    document.getElementById('stdStock').value = data.stdStock || 6000;
    document.getElementById('trim').value = data.trim || 20;
    document.getElementById('kerf').value = data.kerf || 3;
    document.getElementById('weight').value = data.weight || 1.5;
    document.getElementById('profileDesc').value = data.profileDesc || '';
    
    if(data.stock) data.stock.forEach(s => addRow('stockContainer', false, s.len, s.qty));
    if(data.parts) data.parts.forEach(p => addRow('partsContainer', true, p.name, p.len, p.qty));
}

function saveToFile() {
    save(); // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º localStorage –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø–æ–ª–µ–π
    const data = localStorage.getItem(STORAGE_KEY);
    const blob = new Blob([data], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = (document.getElementById('projectName').value || "project") + ".json";
    link.click();
}

function loadFromFile(event) {
    const file = event.target.files[0]; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–∏–ª [0]
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            JSON.parse(content); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON
            localStorage.setItem(STORAGE_KEY, content);
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ load()
        } catch (err) {
            alert("–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");
        }
    };
    reader.readAsText(file);
}


window.onload = load;
</script>
</body>
</html>
