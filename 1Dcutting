<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–∫—Ä–æ–π 1D: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #eceff1; color: #333; font-size: 13px; }
        .container { max-width: 1150px; margin: 0 auto; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #eee; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;}
        
        /* –°–µ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-grid { 
            display: grid; 
            /* –î–µ–ª–∞–µ–º 4 –∫–æ–ª–æ–Ω–∫–∏, –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å—É—Ç—Å—è –Ω–∞ 2 —Å—Ç—Ä–æ–∫–∏ */
            grid-template-columns: repeat(4, 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 9px; font-weight: bold; margin-bottom: 3px; color: #777; text-transform: uppercase; }
        input, select { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; }

        .items-row { display: grid; grid-template-columns: 2fr 1fr 80px 35px; gap: 5px; margin-bottom: 5px; }
        .stock-row { display: grid; grid-template-columns: 1fr 80px 70px 35px; gap: 5px; margin-bottom: 5px; align-items: center; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 36px; display: flex; align-items: center; justify-content: center; }
        .btn-calc { background: #28a745; color: white; flex: 2; font-size: 15px; }
        .btn-add { background: #007bff; color: white; font-size: 10px; height: 24px; padding: 0 10px; }
        .btn-del { background: #ef5350; color: white; height: 32px; width: 32px; padding: 0; }
        
        .actions { display: flex; gap: 10px; margin-top: 15px; align-items: flex-end; }
        .actions .input-group { flex: 1; min-width: 150px; }

        /* –¢–∞–±–ª–∏—Ü—ã */
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; }
        .summary-table th, .summary-table td { border: 1px solid #cfd8dc; padding: 6px 10px; text-align: left; }
        .summary-table th { background: #f8f9fa; font-size: 11px; color: #666; }

        /* –•–ª—ã—Å—Ç—ã */
        .bin-container { margin-bottom: 15px; border: 1px solid #cfd8dc; padding: 10px; border-radius: 6px; background: #fff; page-break-inside: avoid; }
        .bin-info { font-size: 12px; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .bin-bar { height: 32px; background: #eee; display: flex; border-radius: 4px; overflow: hidden; border: 1px solid #ccc; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        
        .part { height: 100%; border-right: 1px solid rgba(255,255,255,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; overflow: hidden; -webkit-print-color-adjust: exact; print-color-adjust: exact; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .part span { font-size: 8px; opacity: 0.9; font-weight: normal; margin-top: -1px; white-space: nowrap; }

        .trim { height: 100%; background: #ff0000 !important; -webkit-print-color-adjust: exact; flex-shrink: 0; }
        .kerf { height: 100%; background: #333 !important; flex-shrink: 0; }
        .waste { height: 100%; background: repeating-linear-gradient(45deg, #fdfdfd, #fdfdfd 5px, #eeeeee 5px, #eeeeee 10px) !important; color: #999; font-size: 9px; display: flex; align-items: center; padding-left: 5px; flex-grow: 1; -webkit-print-color-adjust: exact; }
        
        .summary { background: #e8f5e9; border-left: 5px solid #43a047; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none; }
        .badge-stock { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ø—Ä–∞–≤–∞ */
        .json-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000; /* –≤—Å–µ–≥–¥–∞ –≤—ã—à–µ –ø–∞–Ω–µ–ª–∏ */
            background: #37474f;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* –í—ã–µ–∑–∂–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ */
        .json-panel {
            position: fixed;
            top: 0;
            right: -360px; /* —Å–ø—Ä—è—Ç–∞–Ω–∞ */
            width: 340px;
            height: 100vh;
            background: #ffffff;
            box-shadow: -2px 0 8px rgba(0,0,0,0.25);
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            z-index: 1500; /* –Ω–∏–∂–µ –∫–Ω–æ–ø–∫–∏ */
            overflow: hidden;
        }

        .json-panel.open {
            right: 0;
        }

        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª */
        .json-panel-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            height: 100%;
            padding-right: 5px;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .json-panel h3 {
            margin: 0;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        /* –ü–æ–ª—è */
        .json-panel textarea {
            width: 100%;
            height: 200px;
            resize: none;
            font-size: 12px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px;
            background: #fafafa;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .json-panel .btn-small {
            padding: 6px 10px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #607d8b;
            color: white;
        }

        .json-close {
            background: #d32f2f !important;
        }

        @media print { .panel, .btn-add, .btn-del, .no-print { display: none !important; } }
    </style>
</head>
<body>
<button id="jsonToggle" class="json-toggle no-print">JSON</button>

<div class="container">
    <div class="panel">
        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <div class="settings-grid">
            <div class="input-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="projectName" oninput="save()"></div>
            <div class="input-group"><label>–ù–æ–≤—ã–π —Ö–ª—ã—Å—Ç (–º–º)</label><input type="number" id="stdStock" value="6000" oninput="save()"></div>
            <div class="input-group"><label>–¢–æ—Ä—Ü–æ–≤–∫–∞ (–º–º)</label><input type="number" id="trim" value="20" oninput="save()"></div>
            <div class="input-group"><label>–†–µ–∑ (–º–º)</label><input type="number" id="kerf" value="3" oninput="save()"></div>
            <div class="input-group"><label>–í–µ—Å 1–º (–∫–≥)</label><input type="number" id="weight" step="0.001" value="1.5" oninput="save()"></div>
            <div class="input-group"><label>–í—Ä–µ–º—è —Ä–µ–∑–∞ (—Å–µ–∫)</label><input type="number" id="cutTime" value="30" oninput="save()"></div>
            <div class="input-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label><input type="text" id="profileDesc" oninput="save()"></div>
            <div class="input-group"><label>–í–µ—Ä—Å–∏—è</label><div style="font-size: 11px; color: #999; padding-top: 8px;">PRO v.2.6</div></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1.4fr; gap: 20px;">
            <div>
                <h2>–°–∫–ª–∞–¥ <button class="btn btn-add" onclick="addRow('stockContainer', false)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="stockContainer"></div>
            </div>
            <div>
                <h2>–ó–∞–≥–æ—Ç–æ–≤–∫–∏ <button class="btn btn-add" onclick="addRow('partsContainer', true)">+ –î–æ–±–∞–≤–∏—Ç—å</button></h2>
                <div id="partsContainer"></div>
            </div>
        </div>
        
        <div class="actions">
            <div class="input-group">
                <label>–í–∏–¥ –æ—Ç—á–µ—Ç–∞</label>
                <select id="reportMode" onchange="save(); calculate()">
                    <option value="compact">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π</option>
                    <option value="detailed">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π (—Ç–∞–±–ª–∏—Ü—ã)</option>
                </select>
            </div>
            <button class="btn btn-calc" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <button class="btn" style="background:#673ab7; color:white" onclick="saveToFile()">üíæ JSON</button>
            <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)" accept=".json">
            <button class="btn" style="background:#ff9800; color:white" onclick="document.getElementById('fileInput').click()">üìÇ JSON</button>
            <button class="btn" style="background:#607d8b; color:white" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
            <button class="btn" style="background:#ccc" onclick="clearAll()">–°–±—Ä–æ—Å</button>
        </div>
    </div>

    <div id="summary" class="summary"></div>
    <div id="partsTableArea"></div>
    <div id="results"></div>
    
</div>
<div id="jsonPanel" class="json-panel no-print">
    <div class="json-panel-content">
        <h3>JSON –≤—ã–≤–æ–¥</h3>
        <textarea id="jsonOutput" readonly></textarea>
        <button class="btn-small" onclick="copyJSON()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>

        <h3>JSON –≤–≤–æ–¥</h3>
        <textarea id="jsonInput"></textarea>
        <button class="btn-small" onclick="applyJSON()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –≤–≤–æ–¥–∞</button>

        <button class="btn-small json-close" onclick="toggleJSON()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
const KEY = 'cutData_Final';

function getColor(len) {
    const hue = (len * 137.5) % 360; 
    return `hsl(${hue}, 65%, 35%)`;
}

function addRow(containerId, isPart, val1='', val2='', val3='', val4=false) {
    const row = document.createElement('div');
    row.className = isPart ? 'items-row' : 'stock-row';
    row.innerHTML = isPart ? `
        <input type="text" placeholder="–ò–º—è" class="val-name" value="${val1}" oninput="save()">
        <input type="number" placeholder="–î–ª–∏–Ω–∞" class="val-len" value="${val2}" oninput="save()">
        <input type="number" placeholder="–ö–æ–ª-–≤–æ" class="val-qty" value="${val3}" oninput="save()">
        <button class="btn btn-del" onclick="this.parentElement.remove(); save();">‚úï</button>
    ` : `
        <input type="number" placeholder="–î–ª–∏–Ω–∞" class="val-len" value="${val1}" oninput="save()">
        <input type="number" placeholder="–ö–æ–ª-–≤–æ" class="val-qty" value="${val2}" oninput="save()">
        <label style="font-size:9px;"><input type="checkbox" class="val-trim-extra" ${val4 ? 'checked' : ''} onchange="save()"> –¢–æ—Ä—Ü.—Ö2</label>
        <button class="btn btn-del" onclick="this.parentElement.remove(); save();">‚úï</button>
    `;
    document.getElementById(containerId).appendChild(row);
}

function save() {
    const data = {
        projectName: document.getElementById('projectName').value,
        stdStock: document.getElementById('stdStock').value,
        trim: document.getElementById('trim').value,
        kerf: document.getElementById('kerf').value,
        weight: document.getElementById('weight').value,
        cutTime: document.getElementById('cutTime').value,
        profileDesc: document.getElementById('profileDesc').value,
        reportMode: document.getElementById('reportMode').value,
        stock: Array.from(document.querySelectorAll('#stockContainer .stock-row')).map(r => ({
            len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value, extra: r.querySelector('.val-trim-extra').checked
        })),
        parts: Array.from(document.querySelectorAll('#partsContainer .items-row')).map(r => ({
            name: r.querySelector('.val-name').value, len: r.querySelector('.val-len').value, qty: r.querySelector('.val-qty').value
        }))
    };
    localStorage.setItem(KEY, JSON.stringify(data));
}

function load() {
    const data = JSON.parse(localStorage.getItem(KEY));
    if (!data) { addRow('stockContainer', false, 3000, 1); addRow('partsContainer', true, '–°—Ç–æ–π–∫–∞', 2100, 2); return; }
    document.getElementById('projectName').value = data.projectName || '';
    document.getElementById('stdStock').value = data.stdStock || 6000;
    document.getElementById('trim').value = data.trim || 20;
    document.getElementById('kerf').value = data.kerf || 3;
    document.getElementById('weight').value = data.weight || 1.5;
    document.getElementById('cutTime').value = data.cutTime || 0;
    document.getElementById('profileDesc').value = data.profileDesc || '';
    document.getElementById('reportMode').value = data.reportMode || 'compact';
    document.getElementById('stockContainer').innerHTML = '';
    document.getElementById('partsContainer').innerHTML = '';
    data.stock.forEach(s => addRow('stockContainer', false, s.len, s.qty, '', s.extra));
    data.parts.forEach(p => addRow('partsContainer', true, p.name, p.len, p.qty));
    calculate();
}

function calculate() {
    const kerf = parseFloat(document.getElementById('kerf').value) || 0;
    const trim = parseFloat(document.getElementById('trim').value) || 0;
    const stdStockLen = parseFloat(document.getElementById('stdStock').value);
    const weightPerM = parseFloat(document.getElementById('weight').value) || 0;
    const reportMode = document.getElementById('reportMode').value;

    // --- –°–ë–û–† –î–ê–ù–ù–´–• ---
    let availableStock = [];
    document.querySelectorAll('#stockContainer .stock-row').forEach(row => {
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        const extra = row.querySelector('.val-trim-extra').checked;
        if (len > 0 && qty > 0) {
            for (let i = 0; i < qty; i++) {
                availableStock.push({
                    max: len,
                    current: [],
                    isStock: true,
                    forceDouble: extra
                });
            }
        }
    });

    let partsGrouped = [];
    document.querySelectorAll('#partsContainer .items-row').forEach(row => {
        const name = row.querySelector('.val-name').value || "–î–µ—Ç–∞–ª—å";
        const len = parseFloat(row.querySelector('.val-len').value);
        const qty = parseInt(row.querySelector('.val-qty').value);
        if (len > 0 && qty > 0) {
            partsGrouped.push({ name, len, qty });
        }
    });

    let partsFlat = [];
    partsGrouped.forEach(p => {
        for (let i = 0; i < p.qty; i++) {
            partsFlat.push({ name: p.name, len: p.len });
        }
    });

    partsFlat.sort((a, b) => b.len - a.len);

    // --- –≠–¢–ê–ü 1: –ü–†–ò–û–†–ò–¢–ï–¢ –û–°–¢–ê–¢–ö–û–í ---
    let fixedBins = [];
    let dynamicBins = [];

    // —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —É–ª–æ–∂–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≤ –æ—Å—Ç–∞—Ç–∫–∏
    partsFlat.forEach(p => {
        for (let i = 0; i < availableStock.length; i++) {
            let bin = availableStock[i];
            if (canFit(bin, p, kerf, trim)) {
                bin.current.push(p);
                return;
            }
        }
    });

    // –æ—Å—Ç–∞—Ç–∫–∏, –∫—É–¥–∞ —á—Ç–æ-—Ç–æ —É–ª–æ–∂–∏–ª–æ—Å—å
    fixedBins = availableStock.filter(b => b.current.length > 0);

    // –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ –æ—Å—Ç–∞—Ç–∫–∏
    let remainingParts = partsFlat.filter(p =>
        !fixedBins.some(b => b.current.includes(p))
    );

    // --- –≠–¢–ê–ü 2: —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ö–ª—ã—Å—Ç–æ–≤ ---
    remainingParts.forEach(p =>
        placePartBFD(p, dynamicBins, [], kerf, trim, stdStockLen)
    );

    // --- –≠–¢–ê–ü 3: LNS —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ö–ª—ã—Å—Ç–æ–≤ ---
    dynamicBins = optimizeLNS(dynamicBins, kerf, trim, stdStockLen, 2000);

    // --- –≠–¢–ê–ü 4: –æ–±—ä–µ–¥–∏–Ω—è–µ–º ---
    let usedBins = [...fixedBins, ...dynamicBins];

    // --- –≠–¢–ê–ü 5: —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ ---
    collapseBins(usedBins, kerf, trim);

    // --- –û–¢–†–ò–°–û–í–ö–ê ---
    render(usedBins, kerf, trim, stdStockLen, weightPerM, partsGrouped, reportMode);
    updateJSONPanel();
}


function placePartBFD(part, bins, availableStock, kerf, trim, stdStockLen) {
    let bestIdx = -1;
    let bestRem = Infinity;

    for (let i = 0; i < bins.length; i++) {
        if (canFit(bins[i], part, kerf, trim)) {
            let used = getUsedLength(bins[i], kerf, trim);
            let rem = bins[i].max - (used + part.len + (bins[i].current.length > 0 ? kerf : 0));
            if (rem < bestRem) {
                bestRem = rem;
                bestIdx = i;
            }
        }
    }

    if (bestIdx !== -1) {
        bins[bestIdx].current.push(part);
        return;
    }

    // –∏—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π stock
    let bestStockIdx = -1;
    let bestStockRem = Infinity;

    for (let i = 0; i < availableStock.length; i++) {
        let s = availableStock[i];
        let tMult = s.forceDouble ? 2 : 1;
        let rem = s.max - (part.len + tMult * trim);
        if (rem >= 0 && rem < bestStockRem) {
            bestStockRem = rem;
            bestStockIdx = i;
        }
    }

    if (bestStockIdx !== -1) {
        let bin = availableStock.splice(bestStockIdx, 1)[0];
        bin.current.push(part);
        bins.push(bin);
        return;
    }

    // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ö–ª—ã—Å—Ç
    bins.push({
        max: stdStockLen,
        current: [part],
        isStock: false,
        forceDouble: false
    });
}

function getUsedLength(bin, kerf, trim) {
    const sum = bin.current.reduce((s, x) => s + x.len, 0);
    const kerfTotal = bin.current.length > 1 ? (bin.current.length - 1) * kerf : 0;
    const tMult = bin.isStock ? (bin.forceDouble ? 2 : 1) : 2;
    return sum + kerfTotal + tMult * trim;
}

function canFit(bin, part, kerf, trim) {
    const used = getUsedLength(bin, kerf, trim);
    const newKerf = bin.current.length > 0 ? kerf : 0;
    return used + part.len + newKerf <= bin.max;
}

function checkFit(parts, bin, kerf, trim) {
    let sum = parts.reduce((s, x) => s + x.len, 0);
    let kerfTotal = parts.length > 1 ? (parts.length - 1) * kerf : 0;
    const tMult = bin.isStock ? (bin.forceDouble ? 2 : 1) : 2;
    return sum + kerfTotal + tMult * trim <= bin.max;
}

function scoreSolution(bins, kerf, trim) {
    let score = 0;
    for (let b of bins) {
        const used = getUsedLength(b, kerf, trim);
        const rem = b.max - used;
        score -= rem * rem;
    }
    return score;
}

function generateNeighbor(bins, kerf, trim) {
    let newBins = bins.map(b => ({
        max: b.max,
        isStock: b.isStock,
        forceDouble: b.forceDouble,
        current: [...b.current]
    }));

    if (newBins.length < 2) return newBins;

    let i = Math.floor(Math.random() * newBins.length);
    let j = Math.floor(Math.random() * newBins.length);
    if (i === j) return newBins;

    let b1 = newBins[i];
    let b2 = newBins[j];

    if (b1.current.length === 0 || b2.current.length === 0) return newBins;

    let p1 = Math.floor(Math.random() * b1.current.length);
    let p2 = Math.floor(Math.random() * b2.current.length);

    let A = b1.current[p1];
    let B = b2.current[p2];

    let newB1 = [...b1.current];
    let newB2 = [...b2.current];

    newB1[p1] = B;
    newB2[p2] = A;

    if (checkFit(newB1, b1, kerf, trim) &&
        checkFit(newB2, b2, kerf, trim)) {
        b1.current = newB1;
        b2.current = newB2;
    }

    return newBins;
}


function collapseBins(bins, kerf, trim) {
    for (let i = bins.length - 1; i > 0; i--) {
        for (let j = 0; j < i; j++) {
            let merged = [...bins[j].current, ...bins[i].current];
            if (checkFit(merged, bins[j], kerf, trim)) {
                bins[j].current = merged;
                bins.splice(i, 1);
                break;
            }
        }
    }
}

function optimizeLNS(bins, kerf, trim, stdStockLen, iterations = 2000) {

    // --- 0. –ï—Å–ª–∏ –¥–µ—Ç–∞–ª–µ–π –º–∞–ª–æ ‚Äî LNS –Ω–µ –Ω—É–∂–µ–Ω ---
    let totalParts = bins.reduce((s, b) => s + b.current.length, 0);
    if (totalParts < 20) {
        return bins; // –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    }

    // --- 1. –ì–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è ---
    let best = JSON.parse(JSON.stringify(bins));
    let bestScore = scoreSolution(best, kerf, trim);

    for (let iter = 0; iter < iterations; iter++) {

        // --- 2. –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ ---
        let candidate = JSON.parse(JSON.stringify(best));

        // --- 3. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ ---
        let allParts = [];
        candidate.forEach(b => {
            b.current = b.current.filter(p => p !== undefined && p !== null);
            allParts.push(...b.current);
        });

        // --- 4. –†–∞–∑—Ä—É—à–µ–Ω–∏–µ: —É–¥–∞–ª—è–µ–º 10‚Äì20% –¥–µ—Ç–∞–ª–µ–π ---
        let removeCount = Math.max(3, Math.floor(allParts.length * 0.15));
        let removed = [];

        let indices = new Set();
        while (indices.size < removeCount) {
            indices.add(Math.floor(Math.random() * allParts.length));
        }

        let newAllParts = [];
        for (let i = 0; i < allParts.length; i++) {
            if (indices.has(i)) removed.push(allParts[i]);
            else newAllParts.push(allParts[i]);
        }

        allParts = newAllParts;

        // --- 5. –û—á–∏—â–∞–µ–º —Ö–ª—ã—Å—Ç—ã ---
        candidate.forEach(b => b.current = []);

        // --- 6. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–µ—Ç–∞–ª–∏ ---
        allParts.forEach(p => {
            if (p) placePartBFD(p, candidate, [], kerf, trim, stdStockLen);
        });

        // --- 7. –î–æ–±–∞–≤–ª—è–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ ---
        removed.forEach(p => {
            if (p) placePartBFD(p, candidate, [], kerf, trim, stdStockLen);
        });

        // --- 8. –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Ö–ª—ã—Å—Ç—ã ---
        candidate = candidate.filter(b => b.current.length > 0);

        // --- 9. –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ ---
        collapseBins(candidate, kerf, trim);

        // --- 10. –û—Ü–µ–Ω–∫–∞ ---
        let score = scoreSolution(candidate, kerf, trim);

        // --- 11. SA-–ø—Ä–∏—ë–º ---
        let T = 1 - iter / iterations;
        if (score > bestScore || Math.random() < Math.exp((score - bestScore) / T)) {
            best = candidate;
            bestScore = score;
        }
    }

    return best;
}


function render(bins, kerf, trim, stdStockLen, weightPerM, partsGrouped, mode) {
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    const partsTableArea = document.getElementById('partsTableArea');
    
    results.innerHTML = ''; 
    let newCount = 0; 
    let totalPartsLen = 0; 
    let totalWeightInput = 0; 
    let totalKerfLen = 0;
    let totalCutsCount = 0; // –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
    
    const now = new Date().toLocaleString('ru-RU');
    const cutTimePerOne = parseFloat(document.getElementById('cutTime')?.value) || 0; // –í—Ä–µ–º—è –Ω–∞ 1 —Ä–µ–∑

    // --- –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Ü–≤–µ—Ç–æ–≤ ---
    const colorMap = {};
    partsGrouped.forEach(p => {
        const key = `${p.name}||${p.len}`;
        colorMap[key] = getColor(p.len + p.name.length);
    });

    // --- –°–≤–æ–¥–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –∑–∞–≥–æ—Ç–æ–≤–æ–∫ ---
    let tableHtml = `<table class="summary-table">
        <thead>
            <tr>
                <th style="width:30px">–¶–≤–µ—Ç</th>
                <th>–ò–º—è</th>
                <th>–î–ª–∏–Ω–∞</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–í–µ—Å —à—Ç</th>
                <th>–í—Å–µ–≥–æ</th>
            </tr>
        </thead>
        <tbody>`;
        
    partsGrouped.forEach(p => {
        const key = `${p.name}||${p.len}`;
        const rowColor = colorMap[key];
        totalPartsLen += (p.len * p.qty);
        tableHtml += `
            <tr>
                <td style="background:${rowColor}; border-radius:3px; width:30px;"></td>
                <td><b>${p.name}</b></td>
                <td>${p.len} –º–º</td>
                <td>${p.qty} —à—Ç</td>
                <td>${(p.len * weightPerM / 1000).toFixed(2)} –∫–≥</td>
                <td>${(p.len * p.qty * weightPerM / 1000).toFixed(2)} –∫–≥</td>
            </tr>`;
    });
    document.getElementById('partsTableArea').innerHTML = `
        <div style="font-size:10px; color:#888">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${now}</div>
        <h3>–°–≤–æ–¥–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å –∑–∞–≥–æ—Ç–æ–≤–æ–∫</h3>` + tableHtml + `</tbody></table>`;

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ö–ª—ã—Å—Ç–æ–≤ ---
    bins.forEach((bin, i) => {
        bin.current.sort((a, b) => b.len - a.len);
        if (!bin.isStock) newCount++;
        const sumLen = bin.current.reduce((s, p) => s + p.len, 0);
        const kerfsInBin = bin.current.length > 1 ? (bin.current.length - 1) : 0;
        
        let tMult = bin.isStock ? (bin.forceDouble ? 2 : 1) : 2;
        
        totalKerfLen += (kerfsInBin * kerf);
        totalWeightInput += (bin.max * weightPerM / 1000);
        totalCutsCount += (kerfsInBin + tMult); // –†–µ–∑—ã –¥–µ—Ç–∞–ª–µ–π + —Ç–æ—Ä—Ü–æ–≤–∫–∏

        const waste = bin.max - (sumLen + kerfsInBin * kerf + (tMult * trim));

        let detailedTable = '';
        if (mode === 'detailed') {
            let binMap = {};
            bin.current.forEach(p => { let k = `${p.name}||${p.len}`; binMap[k] = (binMap[k] || 0) + 1; });
            detailedTable = `<table style="width:100%; margin-top:5px; font-size:11px; border-top:1px dashed #ccc;">`;
            for (let k in binMap) {
                let [n, l] = k.split('||');
                detailedTable += `<tr>
                    <td style="width:10px; background:${colorMap[k]}"></td>
                    <td><b>${n}</b></td>
                    <td>${l} –º–º</td>
                    <td>${binMap[k]} —à—Ç</td>
                    <td>${(l * binMap[k] * weightPerM / 1000).toFixed(2)} –∫–≥</td>
                </tr>`;
            }
            detailedTable += `</table>`;
        }

        const wrap = document.createElement('div');
        wrap.className = 'bin-container';
        wrap.innerHTML = `
            <div class="bin-info">
                <span>‚Ññ${i+1} (${bin.max} –º–º) ${bin.isStock ? '<span class="badge-stock">–°–ö–õ–ê–î</span>' : '<b>–ù–û–í–´–ô</b>'} | ${(bin.max * weightPerM / 1000).toFixed(2)} –∫–≥ <span style="color:#d32f2f; margin-left:10px;">(–¢–æ—Ä—Ü–æ–≤–∫–∞: ${tMult}x${trim})</span></span>
                <span>–û—Å—Ç–∞—Ç–æ–∫: <b>${waste.toFixed(0)} –º–º</b></span>
            </div>
            <div class="bin-bar" style="width: ${(bin.max / stdStockLen * 100)}%">
                ${(tMult === 2) ? `<div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>` : ''}
                ${bin.current.map((p, idx) => `
                    <div class="part" style="width: ${(p.len / bin.max * 100)}%; background: ${colorMap[p.name+'||'+p.len]}">
                        ${p.len}<span>${p.name}</span>
                    </div>
                    ${idx < bin.current.length - 1 ? `<div class="kerf" style="width: ${(kerf / bin.max * 100)}%"></div>` : ''}
                `).join('')}
                <div class="waste">${waste > 15 ? Math.floor(waste) : ''}</div>
                <div class="trim" style="width: ${(trim / bin.max * 100)}%"></div>
            </div>${detailedTable}`;
        results.appendChild(wrap);
    });

    // --- –†–ê–°–ß–ï–¢ –ò–¢–û–ì–û–í –ò –ö–ò–ú ---
    const totalInputLen = bins.reduce((s, b) => s + b.max, 0);
    const kim = totalInputLen > 0 ? ((totalPartsLen / totalInputLen) * 100).toFixed(1) : 0;
    const shavingsPercent = totalInputLen > 0 ? ((totalKerfLen / totalInputLen) * 100).toFixed(1) : 0;
    const scrapPercent = (100 - kim - shavingsPercent).toFixed(1);

    const cleanW = (totalPartsLen * weightPerM / 1000).toFixed(2);
    const shavingsW = (totalKerfLen * weightPerM / 1000).toFixed(2);
    const scrapW = (totalWeightInput - cleanW - shavingsW).toFixed(2);

    const totalSec = totalCutsCount * cutTimePerOne;
    const timeStr = `${Math.floor(totalSec/60)}–º ${totalSec%60}—Å`;

    // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 0
    const cutTimeInput = parseFloat(document.getElementById('cutTime').value);
    let timeDisplayHtml = ''; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ

    if (cutTimeInput > 0) {
        const totalSec = totalCutsCount * cutTimeInput;
        const minutes = Math.floor(totalSec / 60);
        const seconds = totalSec % 60;
        const timeStr = minutes > 0 ? `${minutes}–º ${seconds}—Å` : `${seconds}—Å`;
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤—ã–≤–æ–¥–∞
        timeDisplayHtml = `<span style="font-size: 1rem; color: #2c3e50;">‚è± <b>${timeStr}</b> <span style="font-size:0.8rem; color:#888;">(${totalCutsCount} —Ä–µ–∑–æ–≤)</span></span><br>`;
    } else {
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–æ–≤
        timeDisplayHtml = `<span style="font-size: 0.9rem; color: #777;">–í—Å–µ–≥–æ —Ä–µ–∑–æ–≤: <b>${totalCutsCount} —à—Ç.</b></span><br>`;
    }

    summary.style.display = 'block';
    summary.innerHTML = `
        <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:30px; align-items: center;">
            <div>
                <h1 style="margin:0; font-size:1.4rem; color: #2c3e50;">${document.getElementById('projectName').value || '–ü—Ä–æ–µ–∫—Ç'}</h1>
                <p style="margin:5px 0 0 0; color:#444; font-size:1.1rem;">–ü—Ä–æ—Ñ–∏–ª—å: <b>${document.getElementById('profileDesc').value || '‚Äî'}</b></p>
                <div style="margin-top:12px;">
                    <label style="font-size:9px; font-weight:bold; color:#666; letter-spacing:1px;">–ö–ò–ú (–≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –†–ê–°–ö–†–û–Ø):</label>
                    <div style="width:100%; height:16px; background:#eee; border-radius:8px; overflow:hidden; display:flex; border:1px solid #ccc; margin-top:4px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="width:${kim}%; background: linear-gradient(90deg, #28a745, #34ce57);" title="–ü–æ–ª–µ–∑–Ω–æ–µ: ${kim}%"></div>
                        <div style="width:${shavingsPercent}%; background:#333;" title="–°—Ç—Ä—É–∂–∫–∞: ${shavingsPercent}%"></div>
                        <div style="width:${scrapPercent}%; background:#ffc107;" title="–û–±—Ä–µ–∑–∫–∏: ${scrapPercent}%"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-top:5px; font-weight: 500;">
                        <span>–ö–ò–ú: <b style="color:#28a745">${kim}%</b></span>
                        <span>–°—Ç—Ä—É–∂–∫–∞: ${shavingsPercent}%</span>
                        <span>–û–±—Ä–µ–∑–∫–∏: <b style="color:#d39e00">${scrapPercent}%</b></span>
                    </div>
                </div>
            </div>
            <div style="text-align:right; font-size: 0.95rem; line-height: 1.7; border-left: 1px solid #eee; padding-left: 20px;">
                –ó–∞–∫—É–ø–∫–∞: <b>${newCount} —à—Ç.</b> (${(newCount * stdStockLen / 1000).toFixed(2)} –º)<br>
                –û–±—â–∏–π –≤–µ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞: <b>${totalWeightInput.toFixed(2)} –∫–≥</b><br>
                –ß–∏—Å—Ç—ã–π –≤–µ—Å –∏–∑–¥–µ–ª–∏–π: <b style="color:#28a745">${cleanW} –∫–≥</b><br>
                ${timeDisplayHtml}<br>
                <small style="color:#777">–°—Ç—Ä—É–∂–∫–∞: ${shavingsW} –∫–≥ | –û–±—Ä–µ–∑–∫–∏: ${scrapW} –∫–≥</small>
            </div>
        </div>`;
}


function saveToFile() { 
    save(); 
    const blob = new Blob([localStorage.getItem(KEY)], {type:"application/json"});
    const a = document.createElement("a"); 
    a.href = URL.createObjectURL(blob); 
    a.download = (document.getElementById('projectName').value || "project") + ".json"; a.click(); 
}

function loadFromFile(e) { 
    const reader = new FileReader(); 
    reader.onload = (ev) => { localStorage.setItem(KEY, ev.target.result); 
    location.reload(); }; 
    reader.readAsText(e.target.files[0]); 
}

function clearAll() { 
    if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) { 
        localStorage.removeItem(KEY); location.reload(); 
    } 
}

window.onload = load;

function toggleJSON() {
    document.getElementById("jsonPanel").classList.toggle("open");
}

document.getElementById("jsonToggle").onclick = toggleJSON;

function updateJSONPanel() {
    const data = JSON.parse(localStorage.getItem(KEY) || "{}");
    document.getElementById("jsonOutput").value = JSON.stringify(data, null, 2);
}

function copyJSON() {
    const ta = document.getElementById("jsonOutput");
    ta.select();
    document.execCommand("copy");
}

function applyJSON() {
    try {
        const text = document.getElementById("jsonInput").value.trim();
        if (!text) return alert("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ");

        const obj = JSON.parse(text);
        localStorage.setItem(KEY, JSON.stringify(obj));
        location.reload();
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ JSON: " + e.message);
    }
}

</script>

</body>
</html>
